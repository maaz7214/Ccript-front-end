name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20.x'

jobs:
  # Build and Test Job
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build application
        run: |
          if [ -z "${{ secrets.NEXT_PUBLIC_API_BASE_URL }}" ]; then
            echo "ERROR: NEXT_PUBLIC_API_BASE_URL secret is not set!"
            echo "Please add NEXT_PUBLIC_API_BASE_URL to GitHub Secrets"
            exit 1
          fi
          echo "Building with API URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}"
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}

      - name: Verify build output
        run: |
          echo "Verifying build output..."
          if [ ! -d ".next" ]; then
            echo "ERROR: .next directory not found after build!"
            echo "Listing current directory:"
            ls -la
            echo "Checking if build completed successfully..."
            exit 1
          fi
          echo "‚úÖ .next directory exists"
          echo "Checking .next contents:"
          ls -la .next/ | head -10
          echo "Build verification complete"

      - name: Create artifact bundle
        run: |
          echo "Creating artifact bundle..."
          # Create a tar archive that includes all necessary files for production
          tar -czf build-artifacts.tar.gz \
            .next \
            src \
            public \
            package.json \
            package-lock.json \
            node_modules \
            next.config.ts \
            tsconfig.json
          echo "‚úÖ Artifact bundle created"
          ls -lh build-artifacts.tar.gz
          
          # Verify contents
          echo "Verifying bundle contents..."
          tar -tzf build-artifacts.tar.gz | head -20

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build-artifacts.tar.gz
          retention-days: 1
          if-no-files-found: error

  # Deploy to EC2 (only on main branch)
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Extract and verify build artifacts
        run: |
          echo "Extracting build artifacts..."
          if [ ! -f "build-artifacts.tar.gz" ]; then
            echo "ERROR: build-artifacts.tar.gz not found!"
            echo "Listing current directory:"
            ls -la
            exit 1
          fi
          
          echo "Extracting archive..."
          tar -xzf build-artifacts.tar.gz
          
          # Verify .next folder exists after extraction
          if [ ! -d ".next" ]; then
            echo "ERROR: .next folder not found after extraction!"
            echo "Listing current directory:"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ .next folder extracted successfully"
          echo "‚úÖ Verifying .next structure..."
          ls -la .next/ | head -10
          
          # Clean up the tar file
          rm -f build-artifacts.tar.gz

      - name: Create deployment package
        run: |
          # Create deployment package WITHOUT node_modules (we'll install on EC2)
          # This makes the package much smaller and faster to transfer
          echo "Creating deployment package (excluding node_modules)..."
          tar -czf deployment.tar.gz \
            .next \
            src \
            public \
            package.json \
            package-lock.json \
            next.config.ts \
            tsconfig.json
          
          # Verify package integrity
          echo "Verifying package integrity..."
          if ! tar -tzf deployment.tar.gz > /dev/null 2>&1; then
            echo "ERROR: Failed to create valid tar archive!"
            exit 1
          fi
          
          # Verify .next is in the package
          echo "Verifying deployment package contents..."
          if ! tar -tzf deployment.tar.gz | grep -q "^\.next/"; then
            echo "ERROR: .next folder not included in deployment package!"
            echo "Package contents:"
            tar -tzf deployment.tar.gz | head -20
            exit 1
          fi
          
          # Verify src is in the package
          if ! tar -tzf deployment.tar.gz | grep -q "^src/"; then
            echo "ERROR: src folder not included in deployment package!"
            exit 1
          fi
          
          echo "‚úÖ Deployment package created successfully"
          echo "Package size: $(du -h deployment.tar.gz | cut -f1)"
          echo "Package contents preview:"
          tar -tzf deployment.tar.gz | head -10

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'SPACECHECK'
            # Clean up old deployment files and free space
            rm -f /tmp/deployment.tar.gz 2>/dev/null || true
            ls -dt /tmp/backup-* 2>/dev/null | tail -n +3 | xargs rm -rf 2>/dev/null || true
            npm cache clean --force 2>/dev/null || true
            pm2 flush 2>/dev/null || true

            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            [ -d "$$APP_DIR/node_modules" ] && rm -rf "$$APP_DIR/node_modules" 2>/dev/null || true
          SPACECHECK

          for i in 1 2 3; do
            if scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=60 deployment.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/ 2>/dev/null; then
              echo "‚úÖ Upload successful"
              break
            elif [ $i -eq 3 ]; then
              echo "‚ùå SCP failed, trying base64..."
              base64 deployment.tar.gz | ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "base64 -d > /tmp/deployment.tar.gz" || exit 1
              echo "‚úÖ Upload successful (base64)"
            else
              sleep 5
            fi
          done

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'VERIFYEOF'
            [ ! -f "/tmp/deployment.tar.gz" ] && echo "ERROR: File not found!" && exit 1
            tar -tzf /tmp/deployment.tar.gz > /dev/null || exit 1
            echo "‚úÖ File verified"
          VERIFYEOF
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            set -e
            
            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            API_BASE_URL="${{ secrets.NEXT_PUBLIC_API_BASE_URL }}"
            BACKUP_DIR="/tmp/backup-$$(date +%Y%m%d-%H%M%S)"

            [ ! -d "$$APP_DIR" ] && sudo mkdir -p "$$APP_DIR" && sudo chown -R $$USER:$$USER "$$APP_DIR" 2>/dev/null || true

            if [ -d "$$APP_DIR" ] && [ "$$(ls -A $$APP_DIR 2>/dev/null)" ]; then
              mkdir -p "$$BACKUP_DIR"
              rsync -a --exclude='node_modules' --exclude='.next' --exclude='.git' "$$APP_DIR/" "$$BACKUP_DIR/" 2>/dev/null || true
            fi

            ls -dt /tmp/backup-* 2>/dev/null | tail -n +3 | xargs rm -rf 2>/dev/null || true
            cd "$$APP_DIR"

            # Ensure proper permissions before extraction
            sudo chown -R $$USER:$$USER "$$APP_DIR" 2>/dev/null || sudo chmod -R 755 "$$APP_DIR" 2>/dev/null || true

            rm -rf node_modules .next public src 2>/dev/null || true
            tar -xzf /tmp/deployment.tar.gz

            # Ensure extracted files have correct permissions
            sudo chown -R $$USER:$$USER . 2>/dev/null || sudo chmod -R 755 . 2>/dev/null || true

            if [ ! -d ".next" ]; then
              echo "‚ö†Ô∏è  .next missing, rebuilding..."
              npm ci && npm run build && npm ci --production
            fi

            echo "üì¶ Installing dependencies..."
            npm install --production --no-audit --no-fund || npm cache clean --force && npm install --production --no-audit --no-fund

            [ -n "$$API_BASE_URL" ] && echo -e "NODE_ENV=production\nNEXT_PUBLIC_API_BASE_URL=$$API_BASE_URL" > .env.production

            [ ! -d ".next" ] && echo "‚ùå Build failed!" && exit 1
            echo "‚úÖ Build ready"
            
            command -v nginx >/dev/null || { command -v yum >/dev/null && sudo yum install -y nginx || sudo apt-get update && sudo apt-get install -y nginx; }

            printf '%s\n' 'server {' '    listen 80;' '    server_name _;' '' '    location / {' '        proxy_pass http://localhost:3000;' '        proxy_http_version 1.1;' '        proxy_set_header Upgrade $http_upgrade;' '        proxy_set_header Connection "upgrade";' '        proxy_set_header Host $host;' '        proxy_cache_bypass $http_upgrade;' '        proxy_set_header X-Real-IP $remote_addr;' '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' '        proxy_set_header X-Forwarded-Proto $scheme;' '    }' '}' | sudo tee /etc/nginx/conf.d/tumlinson-frontend.conf >/dev/null

            sudo rm -f /etc/nginx/sites-enabled/default /etc/nginx/conf.d/default.conf 2>/dev/null || true

            sudo nginx -t || { echo "‚ùå Nginx config error"; sudo cat /etc/nginx/conf.d/tumlinson-frontend.conf; exit 1; }

            sudo systemctl enable nginx && sudo systemctl restart nginx
            echo "üåê Nginx ready"

            pm2 delete tumlinson-frontend 2>/dev/null || true
            pm2 start npm --name "tumlinson-frontend" -- start -- -H 0.0.0.0
            pm2 save

            rm -f /tmp/deployment.tar.gz
            echo "‚úÖ Deployment successful!"
          EOF

      - name: Verify deployment
        run: |
          sleep 3
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            pm2 list | grep -q "tumlinson-frontend.*online" || { echo "‚ùå PM2 failed"; pm2 logs tumlinson-frontend --lines 20; exit 1; }
            sudo systemctl is-active --quiet nginx || { echo "‚ùå Nginx failed"; exit 1; }

            curl -s -f http://localhost:3000 >/dev/null && echo "‚úÖ App running (port 3000)" || echo "‚ö†Ô∏è  App not responding"
            curl -s -f http://localhost:80 >/dev/null && echo "‚úÖ Nginx proxy working" || echo "‚ö†Ô∏è  Nginx not responding"

            echo "üéâ Deployment verified!"
          ENDSSH
