name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20.x'

jobs:
  # Build and Test Job
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build application
        run: |
          if [ -z "${{ secrets.NEXT_PUBLIC_API_BASE_URL }}" ]; then
            echo "ERROR: NEXT_PUBLIC_API_BASE_URL secret is not set!"
            echo "Please add NEXT_PUBLIC_API_BASE_URL to GitHub Secrets"
            exit 1
          fi
          echo "Building with API URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}"
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}

      - name: Verify build output
        run: |
          echo "Verifying build output..."
          if [ ! -d ".next" ]; then
            echo "ERROR: .next directory not found after build!"
            echo "Listing current directory:"
            ls -la
            echo "Checking if build completed successfully..."
            exit 1
          fi
          echo "✅ .next directory exists"
          echo "Checking .next contents:"
          ls -la .next/ | head -10
          echo "Build verification complete"

      - name: Create artifact bundle
        run: |
          echo "Creating artifact bundle..."
          # Create a tar archive that includes .next (bypasses gitignore)
          tar -czf build-artifacts.tar.gz .next public package.json package-lock.json node_modules
          echo "✅ Artifact bundle created"
          ls -lh build-artifacts.tar.gz

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build-artifacts.tar.gz
          retention-days: 1
          if-no-files-found: error

  # Deploy to EC2 (only on main branch)
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Extract and verify build artifacts
        run: |
          echo "Extracting build artifacts..."
          if [ ! -f "build-artifacts.tar.gz" ]; then
            echo "ERROR: build-artifacts.tar.gz not found!"
            echo "Listing current directory:"
            ls -la
            exit 1
          fi
          
          echo "Extracting archive..."
          tar -xzf build-artifacts.tar.gz
          
          # Verify .next folder exists after extraction
          if [ ! -d ".next" ]; then
            echo "ERROR: .next folder not found after extraction!"
            echo "Listing current directory:"
            ls -la
            exit 1
          fi
          
          echo "✅ .next folder extracted successfully"
          echo "✅ Verifying .next structure..."
          ls -la .next/ | head -10
          
          # Clean up the tar file
          rm -f build-artifacts.tar.gz

      - name: Create deployment package
        run: |
          # Create deployment package with all necessary files
          tar -czf deployment.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            node_modules \
            next.config.ts \
            tsconfig.json \
            2>/dev/null || true
          
          # Verify .next is in the package
          echo "Verifying deployment package contents..."
          if ! tar -tzf deployment.tar.gz | grep -q "^\.next/"; then
            echo "ERROR: .next folder not included in deployment package!"
            echo "Package contents:"
            tar -tzf deployment.tar.gz | head -20
            exit 1
          fi
          
          echo "✅ Deployment package created successfully"
          echo "Package size: $(du -h deployment.tar.gz | cut -f1)"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deployment.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            set -e
            
            # Variables
            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            API_BASE_URL="${{ secrets.NEXT_PUBLIC_API_BASE_URL }}"
            BACKUP_DIR="/tmp/backup-$(date +%Y%m%d-%H%M%S)"
            
            # Create app directory if it doesn't exist (with proper permissions)
            if [ ! -d "\$APP_DIR" ]; then
              echo "Creating application directory: \$APP_DIR"
              # Try to create with sudo if needed, fallback to user directory
              sudo mkdir -p "\$APP_DIR" 2>/dev/null || mkdir -p "\$APP_DIR"
              # Set ownership to current user
              sudo chown -R \$USER:\$USER "\$APP_DIR" 2>/dev/null || chown -R \$USER:\$USER "\$APP_DIR" 2>/dev/null || true
            fi
            
            # Create backup
            if [ -d "\$APP_DIR" ] && [ "\$(ls -A \$APP_DIR 2>/dev/null)" ]; then
              echo "Creating backup..."
              mkdir -p "\$BACKUP_DIR"
              cp -r "\$APP_DIR" "\$BACKUP_DIR/" || true
            fi
            
            # Extract deployment package
            echo "Extracting deployment package..."
            cd "\$APP_DIR"
            
            # Clean old files (keep backups safe)
            rm -rf .next public node_modules 2>/dev/null || true
            
            # Extract deployment package
            tar -xzf /tmp/deployment.tar.gz
            
            # Verify .next folder exists after extraction
            if [ ! -d ".next" ]; then
              echo "ERROR: .next folder not found after extraction!"
              echo "Listing extracted files:"
              ls -la
              echo "Package contents:"
              tar -tzf /tmp/deployment.tar.gz | head -20
              echo "Rebuilding on EC2 as fallback..."
              # Install all dependencies (including dev) for build
              npm ci
              npm run build
              # Remove dev dependencies after build
              npm ci --production
            else
              echo "✅ .next folder extracted successfully"
              # Only install production dependencies if node_modules is missing or incomplete
              if [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ]; then
                echo "Installing production dependencies..."
                npm ci --production
              else
                echo "✅ node_modules already present, skipping npm install"
              fi
            fi
            
            # Create .env.production file if environment variables are provided
            if [ -n "\$API_BASE_URL" ]; then
              echo "Creating .env.production file..."
              echo "NODE_ENV=production" > .env.production
              echo "NEXT_PUBLIC_API_BASE_URL=\$API_BASE_URL" >> .env.production
            fi
            
            # Final verification
            if [ ! -d ".next" ]; then
              echo "ERROR: .next folder still missing after all attempts!"
              exit 1
            fi
            echo "✅ Build verification complete"
            
            # Restart application using PM2
            echo "Restarting application..."
            if pm2 list | grep -q "tumlinson-frontend"; then
              pm2 delete tumlinson-frontend
            fi
            # Start with explicit host binding to 0.0.0.0
            pm2 start npm --name "tumlinson-frontend" -- start -- -H 0.0.0.0
            pm2 save
            
            # Cleanup
            rm -f /tmp/deployment.tar.gz
            echo "Deployment completed successfully!"
          EOF

      - name: Verify deployment
        run: |
          sleep 5
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            if pm2 list | grep -q "tumlinson-frontend.*online"; then
              echo "✅ Application is running successfully!"
              pm2 status
            else
              echo "❌ Application failed to start"
              pm2 logs tumlinson-frontend --lines 50
              exit 1
            fi
          ENDSSH

